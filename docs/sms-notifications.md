# SMS-уведомления в системе ремонта

## Обзор

Система теперь поддерживает автоматические SMS-уведомления для ключевых событий:

1. **Уведомления новым сотрудникам** - при добавлении партнером
2. **Уведомления клиентам** - при создании объекта/сделки
3. **Уведомления партнерам** - при создании сметы сметчиком

## Реализованные функции

### 1. Уведомления сотрудникам

**Когда отправляется:** Партнер создает нового сотрудника через `/partner/employees`

**Содержание SMS:**
- Для существующего пользователя: "Вы добавлены как сметчик к партнеру: {Имя партнера}. Войти в систему: {ссылка}"
- Для нового пользователя: "Вы добавлены как сметчик к партнеру: {Имя партнера}. Ваш пароль: password123. Войти в систему: {ссылка}"

**Файлы:**
- `app/Services/SmsService.php` - метод `sendEmployeeNotification()`
- `app/Http/Controllers/Partner/EmployeeController.php` - интеграция в методы `store()`

### 2. Уведомления клиентам о проектах

**Когда отправляется:** Партнер создает новый объект/проект

**Содержание SMS:**
"Здравствуйте, {Имя клиента}! Для вас создан объект по адресу: {адрес} (тип работ: {тип}). Партнер: {Имя партнера}. Зарегистрируйтесь для отслеживания статуса: {ссылка на регистрацию}"

**Файлы:**
- `app/Services/SmsService.php` - метод `sendProjectNotificationToClient()`
- `app/Http/Controllers/Partner/ProjectController.php` - интеграция в метод `store()`

### 3. Уведомления партнерам о сметах

**Когда отправляется:** Сметчик создает новую смету

**Содержание SMS:**
"Сметчик {Имя сметчика} создал смету: {Название сметы} для проекта: {Информация о проекте}. Проверьте в личном кабинете."

**Файлы:**
- `app/Services/SmsService.php` - метод `sendEstimateNotificationToPartner()`
- `app/Http/Controllers/Partner/EstimateController.php` - интеграция в метод `store()`

## Настройка

### Конфигурация SMS.ru
SMS-сервис использует API SMS.ru со следующими настройками:
- API ключ: `6CDCE0B0-6091-278C-5145-360657FF0F9B`
- Endpoint: `https://sms.ru/sms/send`

### Зависимости
Все контроллеры получают `SmsService` через dependency injection в конструкторе.

## Тестирование

### Консольная команда
```bash
php artisan sms:test +79044482283 --type=all
```

Опции для --type:
- `all` - все типы уведомлений
- `employee` - только уведомления сотрудникам
- `project` - только уведомления клиентам о проектах
- `estimate` - только уведомления партнерам о сметах

### Файл для тестирования
```bash
php test_sms_notifications.php
```

## Логирование

Все SMS-уведомления логируются в файл `storage/logs/laravel.log` с уровнем INFO.

Примеры записей:
- `SMS sending result` - результат отправки SMS
- `Error sending SMS` - ошибки при отправке

## Безопасность

1. **Валидация номеров:** Все номера телефонов очищаются от лишних символов
2. **Лимиты:** Нет ограничений на частоту отправки (можно добавить по необходимости)
3. **Ошибки:** При ошибке отправки SMS система продолжает работу, логируя ошибку

## Возможные улучшения

1. **Настройка шаблонов** - возможность изменять тексты SMS через админ-панель
2. **Очередь SMS** - использование Laravel Queue для отправки SMS в фоне
3. **Статистика** - учет отправленных SMS и их статусов
4. **Лимиты** - ограничения на количество SMS в день/час
5. **Мультиязычность** - поддержка разных языков в SMS
6. **Альтернативные провайдеры** - поддержка других SMS-сервисов

## Структура файлов

```
app/
├── Services/
│   └── SmsService.php                    # Основной сервис SMS
├── Http/Controllers/Partner/
│   ├── EmployeeController.php            # SMS при создании сотрудников
│   ├── ProjectController.php             # SMS при создании проектов
│   └── EstimateController.php            # SMS при создании смет
└── Console/Commands/
    └── TestSmsNotifications.php          # Команда для тестирования

test_sms_notifications.php                # Скрипт для тестирования SMS
```
