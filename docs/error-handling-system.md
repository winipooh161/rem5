# Система обработки ошибок

## Общие сведения

В проекте реализована комплексная система обработки ошибок, которая включает:

1. **Стандартные страницы ошибок** - кастомизированные шаблоны для всех основных HTTP ошибок
2. **Отправка уведомлений в Telegram** - автоматическое оповещение о критических ошибках
3. **Логирование ошибок** - детальное журналирование с контекстом
4. **Дифференцированная обработка для API** - специальные JSON-ответы для API запросов

## Страницы ошибок

В системе настроены следующие страницы ошибок:

- **403** - Доступ запрещен
- **404** - Страница не найдена
- **419** - Страница истекла (CSRF токен)
- **422** - Ошибка валидации
- **429** - Слишком много запросов
- **500** - Внутренняя ошибка сервера
- **503** - Сервис временно недоступен

Все страницы используют общий шаблон `errors/layout.blade.php`, который обеспечивает единообразный стиль.

## Уведомления в Telegram

Система автоматически отправляет уведомления о критических ошибках в Telegram-бот. Настройки бота находятся в `.env` файле:

```
TELEGRAM_BOT_TOKEN=8161282478:AAGB8PSzNjM9mmGTl8fi9L-y0PiQ6xxf0lw
TELEGRAM_CHAT_ID=-4810796860
TELEGRAM_NOTIFICATIONS_ENABLED=true
TELEGRAM_THROTTLE_TIME=60
```

### Информация в уведомлениях

Каждое уведомление об ошибке содержит:

- **Тип ошибки** - полное имя класса исключения
- **Код ошибки** - HTTP код или внутренний код ошибки
- **Сообщение** - текст ошибки
- **Файл и строка** - место, где произошла ошибка
- **URL** - полный URL, на котором произошла ошибка
- **Метод** - HTTP метод запроса (GET, POST, и т.д.)
- **IP-адрес** - IP клиента
- **Пользователь** - ID, email и роль пользователя (если авторизован)
- **User Agent** - информация о браузере/клиенте
- **Реферер** - откуда пришел пользователь
- **Параметры запроса** - данные, отправленные с запросом (кроме паролей)
- **Стек вызовов** - трассировка ошибки (обрезается до 1000 символов)
- **Время** - дата и время возникновения ошибки

### Защита от спама

Система имеет встроенную защиту от спама, которая предотвращает отправку множества одинаковых уведомлений:

1. Для каждой ошибки создается уникальный хеш на основе сообщения, файла и строки
2. Если такая же ошибка уже отправлялась в течение последней минуты, новое уведомление не отправляется

## Обработка ошибок для API

Для API запросов (которые ожидают JSON) система возвращает структурированные JSON-ответы с информацией об ошибке:

```json
{
  "success": false,
  "message": "Текст ошибки",
  "error_type": "Тип ошибки"
}
```

## Тестирование

Для тестирования системы обработки ошибок можно использовать специальные маршруты. Они доступны только когда `APP_DEBUG=true` в файле .env:

- `/test-errors/404` - Тест ошибки "Страница не найдена"
- `/test-errors/403` - Тест ошибки "Доступ запрещен"
- `/test-errors/500` - Тест внутренней ошибки сервера
- `/test-errors/419` - Тест ошибки "Страница истекла" (CSRF)
- `/test-errors/422` - Тест ошибки валидации
- `/test-errors/429` - Тест ошибки "Слишком много запросов"
- `/test-errors/503` - Тест ошибки "Сервис недоступен"

## Расширение системы

Для добавления новых типов обработки ошибок, следует модифицировать файл `app/Exceptions/Handler.php`, добавляя новые обработчики в метод `register()`.
