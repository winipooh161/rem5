# Документация по стандартизированным шаблонам смет

## Общая информация

В системе реализована функциональность по созданию стандартизированных шаблонов смет разных типов. Все шаблоны имеют единую логику, структуру и функциональность, что обеспечивает согласованность работы со сметами во всей системе. Шаблоны заполняются данными из файла `app/Services/Data/WorkSectionsList.php`.

## Доступные типы смет

1. **main** - основная смета на работы (заполняется данными о работах из файла WorkSectionsList.php)
2. **materials** - смета на материалы (генерируется на основе видов работ из файла WorkSectionsList.php)
3. **additional** - смета на дополнительные работы

## Стандартизированные элементы

### Структура всех шаблонов

Все шаблоны имеют единую стандартную структуру:

1. **Заголовок сметы** - отражает тип сметы
2. **Информация о проекте** - объект, заказчик, дата
3. **Заголовки таблицы** - стандартизированные для всех смет:
   - № (номер позиции)
   - Наименование работ/материалов
   - Ед. изм. (единица измерения)
   - Кол-во (количество)
   - Цена, руб.
   - Стоимость, руб. (рассчитывается автоматически)
   - Наценка, %
   - Скидка, %
   - Цена для заказчика (рассчитывается автоматически)
   - Стоимость для заказчика (рассчитывается автоматически)

4. **Итоговая строка** - автоматически считает общие суммы
5. **Примеры работ/материалов** - стандартные примеры для каждого типа сметы

### Форматирование и защита

1. **Единое форматирование** - все шаблоны имеют идентичное форматирование:
   - Форматирование заголовков
   - Форматирование столбцов и строк
   - Выделение разделов и итогов

2. **Стандартная защита** - во всех шаблонах:
   - Разрешено редактирование информации о проекте
   - Разрешено редактирование наименований, единиц измерения, количества, цен, наценок и скидок
   - Запрещено редактирование формул (стоимость, цена для заказчика, стоимость для заказчика)
   - Защита листа с паролем

### Формулы

Все шаблоны используют идентичные формулы для расчетов:

1. **Стоимость** = Количество × Цена
2. **Цена для заказчика** = Цена × (1 + Наценка/100) × (1 - Скидка/100)
3. **Стоимость для заказчика** = Количество × Цена для заказчика
4. **Итоговая стоимость** = Сумма всех значений столбца "Стоимость"
5. **Итоговая стоимость для заказчика** = Сумма всех значений столбца "Стоимость для заказчика"

## Использование

### Генерация шаблонов

Для генерации стандартизированных шаблонов используется команда:

```bash
php artisan estimates:generate-templates
```

Для принудительной перезаписи существующих шаблонов:

```bash
php artisan estimates:generate-templates --force
```

### Структура разделов и номерация

Все шаблоны поддерживают стандартную структуру разделов:
1. Для разделов используется жирный шрифт и заглавные буквы
2. Разделы выделяются цветом фона
3. Нумерация строк сквозная и автоматически обновляется

### Экспорт и импорт

При экспорте и импорте смет сохраняются все стандартизированные элементы, включая форматирование, формулы и защиту.

## Тестирование

Для проверки корректной генерации шаблонов можно запустить тест:

```bash
php artisan test --filter=GenerateEstimateTemplatesTest
```

Тест проверяет:
1. Успешную генерацию шаблонов
2. Наличие всех стандартных элементов в шаблонах
3. Корректность формул и форматирования
